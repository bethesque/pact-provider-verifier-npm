#!/usr/bin/env node
'use strict';

var cp = require('child_process'),
	path = require('path');
var isWindows = process.platform === 'win32';

// figure out the package name based on current platform
var file,
	args = [],
	opts = {
		cwd: path.resolve(__dirname, 'bin'),
		detached: true,
		stdio: 'inherit'
	},
	cmd = ['pact-provider-verifier' + (isWindows ? '.cmd' : '')].concat(process.argv.slice(2)).join(' ');

if (isWindows) {
	file = 'cmd.exe';
	args = ['/s', '/c', cmd];
	opts.windowsVerbatimArguments = true;
	opts.detached = false;
} else {
	cmd = "./" + cmd;
	file = '/bin/sh';
	args = ['-c', cmd];
}

var instance = cp.spawn(file, args, opts);
console.info('Creating Pact process with PID: ' + instance.pid);

// Kill process on node exit
function exit() {
	var exitCode = 0;
	if (instance) {
		instance.removeAllListeners();
		exitCode = instance.exitCode;
		instance = undefined;
	}
	process.removeListener('exit', exit);
	process.removeListener('SIGINT', exit);
	process.exit(exitCode);
}

process.on('exit', exit);
process.on('SIGINT', exit);
